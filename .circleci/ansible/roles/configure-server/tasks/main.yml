---

- name: "Add Node.js"
  become: true
  shell: |
    curl -sL https://deb.nodesource.com/setup_13.x | sudo -E bash -
    apt-get install -y nodejs  
- name: "Install Node.js 13"
  become: true
  apt:
    name: ["nodejs"]
    state: latest
    update_cache: yes

- name: "install python for Ansible."
  become: true
  raw: test -e /usr/bin/python || (apt -y update && apt install -y python3)
  changed_when: false 

- name: Install Yarn NPM package globallyy
  community.general.npm:
    name: yarn@latest
    global: true
  environment:
    PATH: /opt/nodejs/bin:{{ ansible_facts.env.PATH }}

- name: install pm2 
  npm:
    name: pm2
    global: yes
    state: present

- name: create pm2 init.d script
  template:
    src: pm2_init_config.j2
    dest: "/etc/init.d/pm2"
    backup: yes


- name: ensure pm2 service is started
  service:
    name: pm2
    state: started
    enabled: yes



